<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>hserus3</title>
  <style>
    body { background:#111; color:#eee; font-family:Arial, sans-serif; }
    h2 { text-align:center; margin:15px 0; }
    #controls { text-align:center; margin-bottom:10px; }
    button { padding:6px 12px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; }
    button:hover { background:#0056b3; }
    #progress { text-align:center; margin:10px; font-size:14px; }
    table { width:95%; margin:0 auto; border-collapse:collapse; font-size:14px; }
    th, td { border:1px solid #444; padding:6px 8px; text-align:center; }
    th { cursor:pointer; background:#222; }
    tr:nth-child(even) { background:#1a1a1a; }
    .green { color:#0f0; }
    .red { color:#f33; }
  </style>
</head>
<body>
  <h2>hserus3</h2>
  <div id="controls">
    <button onclick="startScan()">ðŸ”„ Refresh Data</button>
  </div>
  <div id="progress"></div>
  <table id="scannerTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Symbol</th>
        <th onclick="sortTable(1)">Close %</th>
        <th onclick="sortTable(2)">Vol %</th>
        <th onclick="sortTable(3)">OI Î”</th>
        <th onclick="sortTable(4)">Long Ratio</th>
        <th onclick="sortTable(5)">New Longs</th>
        <th onclick="sortTable(6)">New Shorts</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const BASE = "https://fapi.binance.com";
let lastData = {}; // memory for previous OI/ratios
let sortDir = true;

async function fetchJSON(url) {
  const r = await fetch(url);
  return r.json();
}

async function getSymbols() {
  let data = await fetchJSON(BASE + "/fapi/v1/exchangeInfo");
  return data.symbols
    .filter(s => s.contractType === "PERPETUAL" && s.symbol.endsWith("USDT"))
    .map(s => s.symbol)
    .slice(0,200); // top 200
}

async function getKlines(symbol) {
  let url = `${BASE}/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=2`;
  return fetchJSON(url);
}

async function getOpenInterest(symbol) {
  let url = `${BASE}/fapi/v1/openInterest?symbol=${symbol}`;
  return fetchJSON(url);
}

async function getLongShortRatio(symbol) {
  let url = `${BASE}/futures/data/globalLongShortAccountRatio?symbol=${symbol}&period=1h&limit=2`;
  return fetchJSON(url);
}

function calcNewLongs(oiChange,longRatio,ratioChange,oi) {
  if(!oiChange || !longRatio) return [0,0];
  let newLongs = (ratioChange/100)*oi + (longRatio/100)*oiChange;
  let newShorts = oiChange - newLongs;
  return [newLongs,newShorts];
}

async function scanSymbol(symbol) {
  try {
    let [klines,oiData,lsData] = await Promise.all([
      getKlines(symbol), getOpenInterest(symbol), getLongShortRatio(symbol)
    ]);

    let prevClose = parseFloat(klines[0][4]);
    let currClose = parseFloat(klines[1][4]);
    let prevVol = parseFloat(klines[0][5]);
    let currVol = parseFloat(klines[1][5]);
    let closeChg = ((currClose - prevClose)/prevClose*100).toFixed(2);
    let volChg = ((currVol - prevVol)/prevVol*100).toFixed(2);

    let currOI = parseFloat(oiData.openInterest);
    let prevOI = lastData[symbol]?.oi || currOI;
    let oiChange = currOI - prevOI;

    let longRatio = parseFloat(lsData[lsData.length-1].longAccount);
    let prevRatio = lastData[symbol]?.ratio || longRatio;
    let ratioChange = longRatio - prevRatio;

    let [newLongs,newShorts] = calcNewLongs(oiChange,longRatio,ratioChange,currOI);

    lastData[symbol] = {oi:currOI, ratio:longRatio};

    return {
      symbol,
      closeChg, volChg,
      oiChange: oiChange.toFixed(2),
      longRatio: (longRatio*100).toFixed(2)+"%",
      newLongs: newLongs.toFixed(2),
      newShorts: newShorts.toFixed(2)
    };
  } catch(e) {
    console.error("Error for",symbol,e);
    return null;
  }
}

async function startScan() {
  document.querySelector("#progress").innerText = "Starting scan...";
  let symbols = await getSymbols();
  let tbody = document.querySelector("#scannerTable tbody");
  tbody.innerHTML = "";

  let results = [];
  for(let i=0;i<symbols.length;i++) {
    document.querySelector("#progress").innerText = `Scanning ${i+1} of ${symbols.length}...`;
    let data = await scanSymbol(symbols[i]);
    if(data) results.push(data);
  }

  tbody.innerHTML = results.map(r => `
    <tr>
      <td style="color:#4af">${r.symbol}</td>
      <td class="${r.closeChg>=0?"green":"red"}">${r.closeChg}%</td>
      <td class="${r.volChg>=0?"green":"red"}">${r.volChg}%</td>
      <td class="${r.oiChange>=0?"green":"red"}">${r.oiChange}</td>
      <td>${r.longRatio}</td>
      <td class="${r.newLongs>=0?"green":"red"}">${r.newLongs}</td>
      <td class="${r.newShorts>=0?"green":"red"}">${r.newShorts}</td>
    </tr>`).join("");

  document.querySelector("#progress").innerText = `Scan complete â€” ${results.length} rows.`;
}

function sortTable(n) {
  let table=document.getElementById("scannerTable"),rows=[...table.rows].slice(1);
  let dir=sortDir?1:-1; sortDir=!sortDir;
  rows.sort((a,b)=>{
    let x=a.cells[n].innerText.replace(/[%]/g,"");
    let y=b.cells[n].innerText.replace(/[%]/g,"");
    return (parseFloat(x)||0 - parseFloat(y)||0)*dir;
  });
  let tbody=table.tBodies[0]; tbody.innerHTML="";
  rows.forEach(r=>tbody.appendChild(r));
}
</script>
</body>
</html>
